<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Test Form</title>
    <style>
        /* Ensure links have the correct default color */
        #linksTable a,
        #processedEmail a {
            color: #2563EB !important; /* Tailwind's blue-600 (Fixes inherited colors) */
            text-decoration: underline;
            transition: color 0.2s ease-in-out;
        }

        /* Hover Effect: Turn links into a brighter blue */
        #linksTable a:hover,
        #processedEmail a:hover {
            color: #1D4ED8 !important; /* Tailwind's blue-700 for hover effect */
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="bg-gradient-to-r from-blue-50 to-purple-100 text-gray-800">
<div class="max-w-3xl mx-auto p-8 bg-white shadow-2xl rounded-2xl mt-12">
    <h2 class="text-3xl font-extrabold text-center text-blue-700">üìß Email Processor Test</h2>

    <!-- Email Form -->
    <form id="emailForm" class="mt-6">
        <label for="emailContent" class="block font-semibold text-gray-700">‚úèÔ∏è Email Content:</label>
        <textarea id="emailContent" rows="10"
                  class="w-full border rounded-lg p-3 mt-2 focus:ring-4 focus:ring-blue-400 min-h-[150px] transition-shadow duration-300"></textarea>

        <button type="button" onclick="sendEmail()" id="sendButton"
                class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition-transform duration-200 transform hover:scale-105 flex items-center gap-2">
            üöÄ Send Email
        </button>
    </form>

    <!-- Processed Email Display -->
    <div id="processedEmailContainer" class="hidden mt-3">
        <h2 class="text-lg font-bold mb-2">üìú Processed Email</h2>
        <div id="processedEmail"
             class="border rounded-lg p-2 bg-gray-50 min-h-[50px] text-sm leading-snug shadow-md">
        </div>
    </div>

    <!-- Shortened Links Table -->
    <h2 class="text-lg font-bold mt-6">üîó Shortened Links</h2>
    <div class="overflow-x-auto">
        <table class="w-full border-collapse border border-gray-300 mt-2 bg-white shadow-lg rounded-lg" id="linksTable">
            <thead class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
            <tr>
                <th class="p-3">ID</th>
                <th class="p-3">Short ID</th>
                <th class="p-3">Expiration</th>
                <th class="p-3">Click Count</th>
                <th class="p-3">Original URL</th>
            </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
            </tbody>
        </table>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal hidden">
    <div class="modal-content w-96 p-6">
        <h2 class="text-xl font-bold text-gray-800">üö¶ Redirect Confirmation</h2>
        <p class="mt-4 text-gray-600">You are about to be redirected to:</p>
        <p id="originalUrlText" class="mt-2 font-semibold text-blue-600 break-words"></p>

        <div class="mt-6 flex justify-center gap-4">
            <button id="confirmRedirect" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg">
                ‚úÖ Proceed
            </button>
            <button onclick="closeModal()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-lg">
                ‚ùå Cancel
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("emailContent").value = `Hello,\n\nHere are a few links:\n1. https://mbl.is\n2. https://google.com\n3. https://dv.is\n\nBest,\nTest User`;

        fetchLinks();
    });

    function sendEmail() {
        const emailContent = document.getElementById("emailContent").value;
        fetch("/process-email", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content: emailContent })
        })
        .then(response => response.text())
        .then(html => {
            let parser = new DOMParser();
            let doc = parser.parseFromString(html, "text/html");

            let emailContentFormatted = doc.body.innerHTML
                .trim()
                .replace(/^\s*<br\s*\/?>/g, "")
                .replace(/\n\s*\n/g, "<br>")
                .replace(/\n/g, "<br>");

            doc.querySelectorAll("a").forEach(link => {
                let hrefValue = link.getAttribute("href");

                let match = hrefValue.match(/\/api\/r\/(.+)/);
                if (match) {
                    let shortId = match[1];
                    link.classList.add("shortened-link");
                    link.setAttribute("data-shortid", shortId);
                    link.setAttribute("href", `/api/r/${shortId}`);
                }
            });

            document.getElementById("processedEmail").innerHTML = emailContentFormatted;
            document.getElementById("processedEmailContainer").classList.remove("hidden");
        })
        .catch(error => alert("Error processing email: " + error));
    }

    function fetchLinks() {
        fetch("/api/links")
        .then(response => response.json())
        .then(data => {
            const tableBody = document.querySelector("#linksTable tbody");
            tableBody.innerHTML = "";
            data.forEach(link => {
                const row = `<tr class="hover:bg-gray-100 transition duration-300">
                    <td class="p-3 border">${link.id}</td>
                    <td class="p-3 border">${link.shortId}</td>
                    <td class="p-3 border">${new Date(link.expiration).toLocaleString()}</td>
                    <td class="p-3 border">${link.clickCount}</td>
                    <td class="p-3 border">
                        <a href="/api/r/${link.shortId}" class="shortened-link" data-shortid="${link.shortId}">
                            ${link.originalUrl}
                        </a>
                    </td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        });
    }

    document.addEventListener("click", function(event) {
        let target = event.target.closest("a.shortened-link");
        if (target && target.dataset.shortid) {
            event.preventDefault();
            let shortId = target.dataset.shortid;
            let originalUrl = `/api/r/${shortId}`;

            showModal(event, shortId, originalUrl);
        }
    });

     function showModal(event, shortId, originalUrl) {
        event.preventDefault();

        // Fetch the original URL from the API
        fetch(`/api/link/${shortId}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.originalUrl) {
                    document.getElementById("originalUrlText").textContent = data.originalUrl; // ‚úÖ Display the real redirect link
                } else {
                    document.getElementById("originalUrlText").textContent = "‚ö†Ô∏è Original URL not found";
                }
            })
            .catch(error => {
                document.getElementById("originalUrlText").textContent = "‚ö†Ô∏è Error fetching URL";
                console.error("Error fetching original URL:", error);
            });

        document.getElementById("confirmRedirect").onclick = () => {
            window.open(originalUrl, "_blank");
            closeModal();
        };

        document.getElementById("confirmModal").style.display = "flex";
    }

    function closeModal() {
        document.getElementById("confirmModal").style.display = "none";
    }
</script>

</body>
</html>
